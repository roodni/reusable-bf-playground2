(function(){"use strict";let i,n,r,d,o,c,f;self.addEventListener("message",e=>{const t=e.data;if(t.t==="start"){switch(i=[{index:0,commands:t.commands}],n=new Array(t.arrayLength).fill(0),t.cellType){case"uint8":c=255;break;case"uint16":c=65535;break;default:throw new Error("never")}r=0,d=t.inputs,o=0,f=t.disableWrapAround,p()}else if(t.t==="continue"){if(t.inputs){if(o!==d.length)throw new Error("unexpected input");d=t.inputs,o=0}p()}});function s(e){self.postMessage(e)}function p(){let e=i[i.length-1];for(;;){for(;e.index===e.commands.length;)if(i.length===1){s({t:"finish"});return}else n[r]!==0?e.index=0:(i.pop(),e=i[i.length-1]);const t=e.commands[e.index];switch(t.t){case"add":{const l=n[r]+t.n,a=l&c;if(f&&l!==a){s({t:"error",kind:"overflow"});return}n[r]=a,e.index++;break}case"shift":if(r+=t.n,r<0||n.length<=r){s({t:"error",kind:"pointer"});return}e.index++;break;case"output":e.index++,s({t:"output",outputs:[n[r]]});return;case"input":if(o<d.length)n[r]=d[o],o++,e.index++;else{s({t:"input"});return}break;case"loop":n[r]!==0?(e.index++,e={index:0,commands:t.commands},i.push(e)):e.index++;break;case"move":{const l=n[r];if(l!==0){for(let a=0;a<t.dest.length;a++){const{index:x,coef:k}=t.dest[a],u=r+x;if(u<0||n.length<=u){s({t:"error",kind:"pointer"});return}const h=n[u]+l*k,m=h&c;if(f&&h!==m){s({t:"error",kind:"overflow"});return}n[u]=m}n[r]=0}e.index++;break}}}}})();
