import "@vitest/web-worker";
import { describe, expect, test } from "vitest";
import { optimize } from "./optimizer";
import { parse } from "./parser";
import { Runner, RunnerEvent } from "./runner";

type TestCase = {
  label: string;
  code: string;
  io: [string, string][];
};

const testCases: TestCase[] = [
  {
    label: "Hello World!",
    code: "+++++++++[->++++++++<]>.<+++++++[->++++<]>+.+++++++..+++.<++++++++>[-]<[->++++<]>.<+++++++++++[->+++++<]>.<++++++[->++++<]>.+++.------.--------.<++++++++>[-]<[->++++<]>+.[-]++++++++++.[-]",
    io: [["", "Hello World!\n"]],
  },
  {
    label: "FizzBuzz",
    code: ">>>>>>>>>>>>>>>++++++++++<<<<<<<<<<<<,----------[-------------------------------------->[-<++++++++++>]<[->+<],----------]+++<<<+++++>>>>[->>>>>>>>>>[>>>>>]+[>>+<[>-]>[-<++++++++++>>]<<->+<[>-<<[-<<<<<]>>]>[-<++++++++++>>>>+>>>]<<<][<<<<<]<<<<++<<-<+>[<->>>-<<<]<[->+++>>>>>++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.+++++++++++++++++++++++++++++++++++.+++++++++++++++++..[-]<<<<<<<]<->+<[>->>>>-<<<<]>[-<+++++>>>>>>>>++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.+++++++++++++++++++++++++++++++++++++++++++++++++++.+++++..[-]<<<<<<]>>>>+<[>-]>[->>>>>>>>[>>>>>]>[<+>>>>>>]<<<<<[>>>++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<<<[->>>-<<<]>>>.<<<++++++++++++++++++++++++++++++++++++++++++++++++++++++++++>>>[-<<<->>>]<<<<-<<<<]<[<<<<<]<<]<<[-]++++++++++++++++++++++++++++++++.[-]<]",
    io: [
      ["16\n", "1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 "],
    ],
  },
  {
    label: "switch",
    code: ",>>>+++++++++++++++++++++++++++++++++++++++++++>+<[-<<+<[>-<->]>[->>>-<[-]<]>]<<+<[>->>>-<<<]>[->]>>>+<[->-<<+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.+++++.-----------.[-]>]>[-<<+>+<[-<<+<[>-<->]>[->>>-<<]>]<<+<[>->>>-<<<]>[->]>>>+<[->-<<+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.--.+++++++++++++++.[-]>]>[-<<+>+<[-<<+<[>-<->]>[->>>-<<]>]<<+<[>->>>-<<<]>[->]>>>+<[->-<<++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.+.--.[-]>]>[-<<+>+<[-<<+<[>-<->]>[->>>-<<]>]<<+<[>->>>-<<<]>[->]>>>+<[->-<<++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.+++++.-.[-]>]>[-<<++++++++++++++>+<[-<<+<[>-<->]>[->>>-<[-]<]>]<<+<[>->>>-<<<]>[->]>>>+<[->-<<+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.-----------.++++.[-]>]>[-<<++>+<[-<<+<[>-<->]>[->>>-<[-]<]>]<<+<[>->>>-<<<]>[->]>>>+<[->-<<+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.-----------.++++++++++.[-]>]>[-<<+++++++++++++++++++++++++++++>+<[-<<+<[>-<->]>[->>>-<[-]<]>]<<+<[>->>>-<<<]>[->]>>>+<[->-<<+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.---------------.+.+++.-------.[-]>]>[-<<++>+<[-<<+<[>-<->]>[->>>-<[-]<]>]<<+<[>->>>-<<<]>[->]>>>+<[->-<<+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.------------------.+++++++++.----------.[-]>]>[-<+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.+++++.------------.---.+++++++++++++.[-]>]]]]]]]]",
    io: [
      ["+", "INC"],
      ["-", "DEC"],
      ["\n", "OTHER"],
    ],
  },
];

describe.each(testCases)("実行できる ($label)", (tc) => {
  const res = parse(tc.code);
  if (res.t === "error") {
    expect.fail(res.msg);
  }
  const commands = optimize(res.commands);

  test.each(tc.io)("#%# 出力が正しい", async (input, want) => {
    const output = await new Promise<string>((resolve, reject) => {
      let buf = "";
      const handler = (ev: RunnerEvent) => {
        if (ev.t === "output") {
          buf += ev.output;
        } else if (ev.t === "finish") {
          resolve(buf);
        } else if (ev.t === "error") {
          reject(ev.kind);
        }
      };
      new Runner(commands, input, handler, {
        mode: "utf8",
      });
    });
    expect(output).toBe(want);
  });
});
